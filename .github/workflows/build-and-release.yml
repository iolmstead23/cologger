name: Build and Release CoLogger

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for version calculation

    - name: Get next version
      id: version
      shell: pwsh
      run: |
        # Get the latest tag
        $tags = git tag --sort=-v:refname
        $latestTag = $tags | Select-Object -First 1

        if (-not $latestTag) {
          # No tags exist, start with v1.0.0
          $newVersion = "v1.0.0"
        } else {
          # Parse the version (assuming format v1.0.0)
          if ($latestTag -match '^v?(\d+)\.(\d+)\.(\d+)$') {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            $patch = [int]$matches[3]

            # Increment patch version
            $patch++
            $newVersion = "v$major.$minor.$patch"
          } else {
            Write-Error "Invalid version format: $latestTag"
            exit 1
          }
        }

        Write-Output "Current version: $latestTag"
        Write-Output "New version: $newVersion"

        # Set output for use in later steps
        echo "version=$newVersion" >> $env:GITHUB_OUTPUT
        echo "version_number=$($newVersion.TrimStart('v'))" >> $env:GITHUB_OUTPUT

    - name: Install PS2EXE module
      shell: pwsh
      run: |
        Set-PSRepository PSGallery -InstallationPolicy Trusted
        Install-Module -Name PS2EXE -Scope CurrentUser -Force
        Import-Module PS2EXE -Force

    - name: Create output directory
      shell: pwsh
      run: |
        New-Item -Path "./bin" -ItemType Directory -Force

    - name: Convert script to EXE
      shell: pwsh
      run: |
        # Use a temporary directory without spaces to avoid CSC compiler issues
        $tempBuildDir = "C:\temp-cologger-build"
        New-Item -Path $tempBuildDir -ItemType Directory -Force | Out-Null

        # Define paths
        $sourceScript = "./cologger.master.ps1"
        $tempScript = Join-Path $tempBuildDir "cologger.master.ps1"
        $tempExe = Join-Path $tempBuildDir "cologger.exe"
        $finalExe = "./bin/cologger.exe"

        # Verify input file exists
        if (-not (Test-Path $sourceScript)) {
          Write-Error "Input file not found: $sourceScript"
          exit 1
        }

        # Copy script to temp directory
        Copy-Item $sourceScript -Destination $tempScript -Force

        # Build in temp directory (no spaces in path)
        Push-Location $tempBuildDir
        try {
          Invoke-ps2exe -inputFile "cologger.master.ps1" -outputFile "cologger.exe"

          if (-not (Test-Path "cologger.exe")) {
            Write-Error "Failed to create executable"
            exit 1
          }
        }
        finally {
          Pop-Location
        }

        # Copy executable to final location
        Copy-Item $tempExe -Destination $finalExe -Force

        # Cleanup temp directory
        Remove-Item $tempBuildDir -Recurse -Force -ErrorAction SilentlyContinue

        # Verify final output
        if (-not (Test-Path $finalExe)) {
          Write-Error "Failed to copy executable to final location"
          exit 1
        }

        Write-Output "Successfully created: $finalExe"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cologger-${{ steps.version.outputs.version }}
        path: ./bin/cologger.exe

    - name: Create Git tag
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a $version -m "Release $version"
        git push origin $version

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: CoLogger ${{ steps.version.outputs.version }}
        body: |
          ## CoLogger Release ${{ steps.version.outputs.version }}

          Automated release of CoLogger executable built from PowerShell script.

          ### Changes
          - Built from: `cologger.master.ps1`
          - Commit: ${{ github.sha }}

          ### Installation
          Download `cologger.exe` and run it on Windows.
        files: |
          ./bin/cologger.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
