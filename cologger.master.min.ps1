#Requires -Version 5.1
$ErrorActionPreference='Stop';$LLM_ENDPOINT='http://localhost';$LLM_PORT=11434;$LLM_PATH='/v1/chat/completions';$LLM_MODEL='qwen2.5:latest';$LLM_TEMPERATURE=0.3;$LLM_MAX_TOKENS=4096;$LLM_TIMEOUT=30;$DEFAULT_PROMPT='You are an expert log analysis assistant for IT Service Desk. Analyze the provided logs and identify errors, warnings, and issues. Provide clear, actionable insights.';$SCRIPT_ROOT=$PSScriptRoot
function Get-Configuration{param();try{return [PSCustomObject]@{apiEndpoint=$LLM_ENDPOINT;apiPort=$LLM_PORT;apiPath=$LLM_PATH;model=$LLM_MODEL;temperature=$LLM_TEMPERATURE;maxTokens=$LLM_MAX_TOKENS;timeoutSeconds=$LLM_TIMEOUT;systemPrompt=$DEFAULT_PROMPT}}catch{Write-Error "Failed to load configuration: $_";throw}}
function Clear-Screen{Clear-Host}
function Show-Header{try{Write-Host "";Write-Host "================================" -ForegroundColor Cyan;Write-Host "    CoLogger - Log Analysis    " -ForegroundColor Cyan;Write-Host "================================" -ForegroundColor Cyan;Write-Host ""}catch{Write-Error "Failed to display menu header: $_"}}
function Show-Option{param([Parameter(Mandatory=$true)][int]$OptionNumber,[Parameter(Mandatory=$true)][string]$OptionText);try{Write-Host "$OptionNumber. $OptionText" -ForegroundColor White}catch{Write-Error "Failed to display menu option: $_"}}
function Get-Choice{param([Parameter(Mandatory=$true)][int]$MinChoice,[Parameter(Mandatory=$true)][int]$MaxChoice);try{Write-Host "";$u=Read-Host "Enter your choice ($MinChoice-$MaxChoice)";$c=0;if(-not [int]::TryParse($u,[ref]$c)){Write-Warning "Invalid input. Please enter a number between $MinChoice and $MaxChoice.";return -1};if($c -lt $MinChoice -or $c -gt $MaxChoice){Write-Warning "Invalid choice. Please select a number between $MinChoice and $MaxChoice.";return -1};return $c}catch{Write-Error "Failed to get user menu choice: $_";return -1}}
function Show-Menu{try{Clear-Screen;Show-Header;Show-Option -OptionNumber 1 -OptionText "Test LLM Connection";Show-Option -OptionNumber 2 -OptionText "Analyze Logs & Generate Report";Show-Option -OptionNumber 3 -OptionText "Exit";$u=Get-Choice -MinChoice 1 -MaxChoice 3;return $u}catch{Write-Error "Failed to display main menu: $_";return -1}}
function Test-LogFolder{param();$p=Join-Path $SCRIPT_ROOT 'logs';if(Test-Path $p -PathType Container){return $true};Write-Warning "Logs folder not found: $p";return $false}
function Get-Logs{try{if(-not (Test-LogFolder)){Write-Warning "Cannot get log files - logs folder does not exist.";return @()};$p=Join-Path $SCRIPT_ROOT 'logs';try{$l=Get-ChildItem -Path $p -Filter "*.log" -File -ErrorAction Stop;if($l.Count -eq 0){Write-Warning "No .log files found in: $p";return @()};return $l.FullName}catch{Write-Error "Failed to retrieve log files: $_";return @()}}catch{Write-Error "Failed to get log files: $_";return @()}}
function Get-Metadata{param([Parameter(Mandatory=$true)][string]$FilePath);try{if(-not (Test-Path -Path $FilePath -PathType Leaf)){Write-Error "Log file not found: $FilePath";return $null};try{$f=Get-Item -Path $FilePath -ErrorAction Stop;$m=[PSCustomObject]@{Name=$f.Name;SizeBytes=$f.Length;SizeKB=[math]::Round($f.Length/1KB,2);SizeMB=[math]::Round($f.Length/1MB,2);LastModified=$f.LastWriteTime;FullPath=$f.FullName};return $m}catch{Write-Error "Failed to retrieve file metadata: $_";return $null}}catch{Write-Error "Failed to get log file metadata: $_";return $null}}
function Read-Log{param([Parameter(Mandatory=$true)][string]$FilePath);try{if(-not (Test-Path -Path $FilePath -PathType Leaf)){Write-Error "Log file not found: $FilePath";return $null};$m=Get-Metadata -FilePath $FilePath;if($m.SizeMB -gt 10){Write-Warning "Large log file detected: $($m.Name) ($($m.SizeMB) MB)"};try{$c=Get-Content -Path $FilePath -Raw -Encoding UTF8 -ErrorAction Stop;return $c}catch{Write-Error "Failed to read log file content: $_";return $null}}catch{Write-Error "Failed to read log file: $_";return $null}}
function Get-Combined{try{$l=Get-Logs;if($l.Count -eq 0){Write-Warning "No log files available to read.";return $null};$c=New-Object System.Text.StringBuilder;foreach($p in $l){$m=Get-Metadata -FilePath $p;if($null -eq $m){Write-Warning "Failed to get metadata for: $p";continue};$f=Read-Log -FilePath $p;if($null -eq $f){Write-Warning "Failed to read content for: $p";continue};[void]$c.AppendLine("=" * 80);[void]$c.AppendLine("FILE: $($m.Name)");[void]$c.AppendLine("SIZE: $($m.SizeKB) KB");[void]$c.AppendLine("MODIFIED: $($m.LastModified)");[void]$c.AppendLine("=" * 80);[void]$c.AppendLine("");[void]$c.AppendLine($f);[void]$c.AppendLine("")};Write-Host "Combined $($l.Count) log file(s) successfully.";return $c.ToString()}catch{Write-Error "Failed to get combined log content: $_";return $null}}
function Build-Payload{param([Parameter(Mandatory=$true)][string]$SystemPrompt,[Parameter(Mandatory=$true)][string]$UserMessage,[string]$Model='default',[ValidateRange(0.0,1.0)][double]$Temperature=0.3,[ValidateRange(1,100000)][int]$MaxTokens=4096);try{$r=@{model=$Model;messages=@(@{role='system';content=$SystemPrompt},@{role='user';content=$UserMessage});temperature=$Temperature;max_tokens=$MaxTokens};try{$j=$r|ConvertTo-Json -Depth 10 -ErrorAction Stop;return $j}catch{Write-Error "Failed to convert request object to JSON: $_";return $null}}catch{Write-Error "Failed to build LLM request payload: $_";return $null}}
function Send-Request{param([Parameter(Mandatory=$true)][string]$ApiUrl,[Parameter(Mandatory=$true)][string]$JsonPayload,[ValidateRange(1,300)][int]$TimeoutSeconds=30);try{try{$r=Invoke-RestMethod -Uri $ApiUrl -Method Post -Body $JsonPayload -ContentType "application/json" -TimeoutSec $TimeoutSeconds -ErrorAction Stop;return $r}catch{Write-Error "Failed to send request to LLM API: $_";return $null}}catch{Write-Error "Failed to execute LLM request: $_";return $null}}
function Test-Connection{param([Parameter(Mandatory=$true)][string]$ApiEndpoint,[Parameter(Mandatory=$true)][ValidateRange(1,65535)][int]$ApiPort,[Parameter(Mandatory=$true)][string]$ApiPath,[string]$Model='qwen2.5:latest',[ValidateRange(1,60)][int]$TimeoutSeconds=10);try{$a="$($ApiEndpoint):$($ApiPort)$($ApiPath)";Write-Host "Testing LLM connection to: $a";$t=Build-Payload -SystemPrompt "You are a helpful assistant." -UserMessage "Respond with OK if you can read this." -Model $Model -Temperature 0.1 -MaxTokens 10;if($null -eq $t){Write-Error "Failed to build test payload";return $false};$r=Send-Request -ApiUrl $a -JsonPayload $t -TimeoutSeconds $TimeoutSeconds;if($null -eq $r){Write-Warning "LLM API did not respond or returned an error";return $false};Write-Host "LLM connection successful!" -ForegroundColor Green;return $true}catch{Write-Error "Failed to test LLM connection: $_";return $false}}
function Invoke-Analysis{param([Parameter(Mandatory=$true)][string]$LogContent,[Parameter(Mandatory=$true)][string]$ApiEndpoint,[Parameter(Mandatory=$true)][ValidateRange(1,65535)][int]$ApiPort,[Parameter(Mandatory=$true)][string]$ApiPath,[Parameter(Mandatory=$true)][string]$SystemPrompt,[string]$Model='default',[ValidateRange(0.0,1.0)][double]$Temperature=0.3,[ValidateRange(1,100000)][int]$MaxTokens=4096,[ValidateRange(1,300)][int]$TimeoutSeconds=30);try{$a="$($ApiEndpoint):$($ApiPort)$($ApiPath)";Write-Host "Sending logs to LLM for analysis...";$u="Please analyze the following logs and identify any errors, warnings, or issues. Provide clear, actionable insights:`n`n$LogContent";$p=Build-Payload -SystemPrompt $SystemPrompt -UserMessage $u -Model $Model -Temperature $Temperature -MaxTokens $MaxTokens;if($null -eq $p){Write-Error "Failed to build analysis request payload";return $null};$r=Send-Request -ApiUrl $a -JsonPayload $p -TimeoutSeconds $TimeoutSeconds;if($null -eq $r){Write-Error "Failed to get analysis response from LLM";return $null};try{$t=$r.choices[0].message.content;Write-Host "Analysis received successfully from LLM" -ForegroundColor Green;return $t}catch{Write-Error "Failed to extract analysis text from response: $_";return $null}}catch{Write-Error "Failed to invoke LLM analysis: $_";return $null}}
function Test-ReportFolder{param();$p=Join-Path $SCRIPT_ROOT 'reports';if(Test-Path $p -PathType Container){return $true};Write-Warning "Reports folder not found: $p";return $false}
function Get-ReportName{try{$t=Get-Date -Format "yyyy-MM-dd_HHmmss";$f="Report_$t.md";return $f}catch{Write-Error "Failed to generate report filename: $_";return $null}}
function Format-Section{param([Parameter(Mandatory=$true)][string]$HeaderText,[Parameter(Mandatory=$true)][AllowEmptyString()][string]$Content,[ValidateRange(1,6)][int]$HeaderLevel=2);try{$h="#"*$HeaderLevel;$s="$h $HeaderText`n`n$Content`n";return $s}catch{Write-Error "Failed to format report section: $_";return $null}}
function New-Report{param([Parameter(Mandatory=$true)][string]$AnalysisText,[Parameter(Mandatory=$true)][string[]]$LogFileNames,[string]$Summary='Log analysis completed successfully.');try{$b=New-Object System.Text.StringBuilder;$t=Get-Date -Format "yyyy-MM-dd HH:mm:ss";[void]$b.AppendLine("# Log Analysis Report");[void]$b.AppendLine("**Generated:** $t");[void]$b.AppendLine("");$s=Format-Section -HeaderText "Summary" -Content $Summary -HeaderLevel 2;[void]$b.Append($s);[void]$b.AppendLine("");$l=($LogFileNames|ForEach-Object{"- $_"})-join "`n";$ls=Format-Section -HeaderText "Log Sources Analyzed" -Content $l -HeaderLevel 2;[void]$b.Append($ls);[void]$b.AppendLine("");$a=Format-Section -HeaderText "Detailed Analysis" -Content $AnalysisText -HeaderLevel 2;[void]$b.Append($a);return $b.ToString()}catch{Write-Error "Failed to create report: $_";return $null}}
function Save-Report{param([Parameter(Mandatory=$true)][string]$ReportContent,[string]$CustomFileName);try{if(-not (Test-ReportFolder)){Write-Warning "Reports folder does not exist. Creating it now...";$p=Join-Path $SCRIPT_ROOT 'reports';New-Item -Path $p -ItemType Directory -Force|Out-Null};$f=if($CustomFileName){$CustomFileName}else{Get-ReportName};if($null -eq $f){Write-Error "Failed to determine report filename";return $false};$p=Join-Path $SCRIPT_ROOT 'reports';$fp=Join-Path -Path $p -ChildPath $f;try{Set-Content -Path $fp -Value $ReportContent -Encoding UTF8 -ErrorAction Stop;Write-Host "Report saved successfully: $fp" -ForegroundColor Green;return $true}catch{Write-Error "Failed to write report file: $_";return $false}}catch{Write-Error "Failed to save report to file: $_";return $false}}
function Test-PromptsFolder{param();$p=Join-Path $SCRIPT_ROOT 'prompts';if(Test-Path $p -PathType Container){return $true};Write-Warning "Prompts folder not found: $p";return $false}
function Get-Templates{try{if(-not (Test-PromptsFolder)){return @()};$p=Join-Path $SCRIPT_ROOT 'prompts';try{$tf=Get-ChildItem -Path $p -Filter "*.txt" -File -ErrorAction Stop|Where-Object{$_.Name -ne "README.txt"};if($tf.Count -eq 0){return @()};$t=@();foreach($f in $tf){$b=[System.IO.Path]::GetFileNameWithoutExtension($f.Name);$w=$b -replace '[-_]',' ';$ws=$w -split '\s+';$tc=$ws|ForEach-Object{if($_.Length -gt 0){$_.Substring(0,1).ToUpper()+$_.Substring(1).ToLower()}};$d=($tc -join ' ');$t+=[PSCustomObject]@{DisplayName=$d;FileName=$f.Name;FilePath=$f.FullName}};return $t}catch{Write-Error "Failed to retrieve template files: $_";return @()}}catch{Write-Error "Failed to get prompt templates: $_";return @()}}
function Read-Template{param([Parameter(Mandatory=$true)][string]$FilePath);try{if(-not (Test-Path -Path $FilePath -PathType Leaf)){Write-Error "Template file not found: $FilePath";return $null};try{$c=Get-Content -Path $FilePath -Raw -Encoding UTF8 -ErrorAction Stop;$tc=$c.Trim();return $tc}catch{Write-Error "Failed to read template file content: $_";return $null}}catch{Write-Error "Failed to read template file: $_";return $null}}
function Show-PromptMenu{try{Clear-Host;Write-Host "";Write-Host "===================================" -ForegroundColor Cyan;Write-Host "   Select Analysis Prompt Template" -ForegroundColor Cyan;Write-Host "===================================" -ForegroundColor Cyan;Write-Host "";$t=Get-Templates;$o=1;$m=@{};foreach($tm in $t){Write-Host "$o. $($tm.DisplayName)" -ForegroundColor White;$m[$o]=$tm;$o++};Write-Host "$o. Default (Standard IT Service Desk analysis)" -ForegroundColor White;$m[$o]=@{DisplayName="Default";PromptSource="default"};$mc=$o;Write-Host "";$u=Read-Host "Enter your choice (1-$mc)";$c=0;if(-not [int]::TryParse($u,[ref]$c)){Write-Warning "Invalid input. Using default prompt.";return @{PromptSource="default";TemplateContent="";CustomText=""}};if($c -lt 1 -or $c -gt $mc){Write-Warning "Invalid choice. Using default prompt.";return @{PromptSource="default";TemplateContent="";CustomText=""}};$s=$m[$c];Write-Host "";Write-Host "Selected: $($s.DisplayName)" -ForegroundColor Green;Write-Host "";$tc="";if($s.PromptSource -ne "default"){$tc=Read-Template -FilePath $s.FilePath;if([string]::IsNullOrWhiteSpace($tc)){Write-Error "Failed to read template file. Using default prompt.";return @{PromptSource="default";TemplateContent="";CustomText=""}}};Write-Host "Would you like to add custom instructions? (Y/N)" -NoNewline;$a=Read-Host " ";$ct="";if($a -eq "Y" -or $a -eq "y"){Write-Host "";Write-Host "Enter custom text to append:" -ForegroundColor Cyan;$ct=Read-Host};return @{PromptSource=if($s.PromptSource -eq "default"){"default"}else{"template"};TemplateContent=$tc;CustomText=$ct}}catch{Write-Error "Failed to show prompt selection menu: $_";return @{PromptSource="default";TemplateContent="";CustomText=""}}}
function Build-Prompt{param([Parameter(Mandatory=$true)][string]$TemplateContent,[string]$CustomText='');try{if([string]::IsNullOrWhiteSpace($CustomText)){return $TemplateContent};$f="$TemplateContent`n`n--- Additional Instructions ---`n$CustomText";return $f}catch{Write-Error "Failed to build final system prompt: $_";return $TemplateContent}}
function Get-DefaultPrompt{try{$d="You are an expert log analysis assistant for IT Service Desk. Analyze the provided logs and identify errors, warnings, and issues. Provide clear, actionable insights.";return $d}catch{Write-Error "Failed to get default system prompt: $_";throw}}
function Initialize-Folders{try{Write-Host "Validating required folders..." -ForegroundColor Cyan;$r=@('logs','reports','prompts');foreach($fn in $r){$fp=Join-Path -Path $SCRIPT_ROOT -ChildPath $fn;if(Test-Path -Path $fp -PathType Container){continue};Write-Warning "Folder '$fn' does not exist. Creating it now...";try{New-Item -Path $fp -ItemType Directory -Force -ErrorAction Stop|Out-Null;Write-Host "Created folder: $fp" -ForegroundColor Green}catch{Write-Error "Failed to create folder '$fn': $_";return $false}};Write-Host "All required folders validated successfully." -ForegroundColor Green;return $true}catch{Write-Error "Failed to initialize required folders: $_";return $false}}
function Invoke-TestConnection{try{Write-Host "`n" -NoNewline;Write-Host "=== Test LLM Connection ===" -ForegroundColor Cyan;Write-Host "";Write-Host "Loading configuration..." -ForegroundColor Cyan;$c=Get-Configuration;if($null -eq $c){Write-Error "Failed to load configuration";Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "Validating configuration settings..." -ForegroundColor Cyan;if([string]::IsNullOrWhiteSpace($c.apiEndpoint)){Write-Error "Configuration missing 'apiEndpoint' field";Write-Host "Suggestion: Edit script variables at top of CoLogger-Master.ps1" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};if($null -eq $c.apiPort -or $c.apiPort -lt 1 -or $c.apiPort -gt 65535){Write-Error "Configuration has invalid 'apiPort' value";Write-Host "Suggestion: Edit script variables at top of CoLogger-Master.ps1" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};if([string]::IsNullOrWhiteSpace($c.apiPath)){Write-Error "Configuration missing 'apiPath' field";Write-Host "Suggestion: Edit script variables at top of CoLogger-Master.ps1" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};$f="$($c.apiEndpoint):$($c.apiPort)$($c.apiPath)";Write-Host "  API Endpoint: $f" -ForegroundColor Gray;Write-Host "";Write-Host "Testing connection to LLM API..." -ForegroundColor Cyan;$ts=if($c.timeoutSeconds){$c.timeoutSeconds}else{10};$cs=Test-Connection -ApiEndpoint $c.apiEndpoint -ApiPort $c.apiPort -ApiPath $c.apiPath -Model $c.model -TimeoutSeconds $ts;Write-Host "";if($cs){Write-Host "[OK] LLM API connection successful!" -ForegroundColor Green;Write-Host "  The LLM service is reachable and responding." -ForegroundColor Green}else{Write-Host "[FAILED] LLM API connection failed" -ForegroundColor Red;Write-Host "";Write-Host "Troubleshooting Steps:" -ForegroundColor Yellow;Write-Host "  1. Verify your LLM service (e.g. LM Studio, Ollama) is running" -ForegroundColor Yellow;Write-Host "  2. Check the API endpoint: $f" -ForegroundColor Yellow;Write-Host "  3. Ensure firewall is not blocking port $($c.apiPort)" -ForegroundColor Yellow;Write-Host "  4. Test connectivity: Test-NetConnection localhost -Port $($c.apiPort)" -ForegroundColor Yellow;Write-Host "  5. Verify the API path is correct for your LLM service" -ForegroundColor Yellow};Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}catch{Write-Error "An unexpected error occurred while testing LLM connection: $_";Write-Host "Suggestion: Check the error message above for details" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}}
function Invoke-Analyze{try{Write-Host "`n" -NoNewline;Write-Host "=== Analyze Logs and Generate Report ===" -ForegroundColor Cyan;Write-Host "";Write-Host "Checking logs folder..." -ForegroundColor Cyan;$lfe=Test-LogFolder;if(-not $lfe){Write-Error "Logs folder not found";Write-Host "Suggestion: Ensure the 'logs' folder exists in the application directory" -ForegroundColor Yellow;Write-Host "Place your .log files in the logs folder before running analysis" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "Scanning for log files..." -ForegroundColor Cyan;$lf=Get-Logs;if($null -eq $lf -or $lf.Count -eq 0){Write-Warning "No .log files found in logs folder";Write-Host "Suggestion: Place .log files in the logs folder before running analysis" -ForegroundColor Yellow;Write-Host "Supported format: *.log files" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "  → Found $($lf.Count) log file(s) to analyze" -ForegroundColor Gray;Write-Host "";Write-Host "Reading log file contents..." -ForegroundColor Cyan;$clc=Get-Combined;if([string]::IsNullOrWhiteSpace($clc)){Write-Error "Failed to read log file contents";Write-Host "Suggestion: Check that log files are not locked or corrupted" -ForegroundColor Yellow;Write-Host "Verify file permissions allow read access" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};$lsk=[math]::Round($clc.Length/1KB,2);Write-Host "  → Combined log size: $lsk KB" -ForegroundColor Gray;if($lsk -gt 100){Write-Warning "Large log files detected. Analysis may take longer than usual."};Write-Host "";Write-Host "Loading LLM configuration..." -ForegroundColor Cyan;$c=Get-Configuration;if($null -eq $c){Write-Error "Failed to load configuration";Write-Host "Suggestion: Edit script variables at top of CoLogger-Master.ps1" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "  → Configuration loaded" -ForegroundColor Gray;Write-Host "";Write-Host "Selecting analysis prompt..." -ForegroundColor Cyan;$ps=Show-PromptMenu;if($null -eq $ps){Write-Error "Failed to select prompt template";Write-Host "Using default prompt as fallback..." -ForegroundColor Yellow;$fsp=Get-DefaultPrompt}else{$bp=if($ps.PromptSource -eq "template"){$ps.TemplateContent}else{Get-DefaultPrompt};$fsp=Build-Prompt -TemplateContent $bp -CustomText $ps.CustomText};Write-Host "  → Prompt configured" -ForegroundColor Gray;Write-Host "";Write-Host "Testing LLM connectivity..." -ForegroundColor Cyan;$ts=if($c.timeoutSeconds){$c.timeoutSeconds}else{10};$lcs=Test-Connection -ApiEndpoint $c.apiEndpoint -ApiPort $c.apiPort -ApiPath $c.apiPath -Model $c.model -TimeoutSeconds $ts;if(-not $lcs){Write-Error "Cannot connect to LLM API";Write-Host "Suggestion: Run 'Test LLM Connection' menu option for detailed troubleshooting" -ForegroundColor Yellow;Write-Host "Ensure your LLM service (e.g. LM Studio, Ollama) is running" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "  → LLM connection verified" -ForegroundColor Gray;Write-Host "";Write-Host "Sending logs to LLM for analysis..." -ForegroundColor Cyan;Write-Host "  (This may take a while depending on log size and model speed)" -ForegroundColor Gray;Write-Host "";$ar=Invoke-Analysis -LogContent $clc -ApiEndpoint $c.apiEndpoint -ApiPort $c.apiPort -ApiPath $c.apiPath -SystemPrompt $fsp -Model $c.model -Temperature $c.temperature -MaxTokens $c.maxTokens -TimeoutSeconds $c.timeoutSeconds;if([string]::IsNullOrWhiteSpace($ar)){Write-Error "Failed to receive analysis from LLM";Write-Host "Suggestion: Check LLM service logs for errors" -ForegroundColor Yellow;Write-Host "Verify LLM has sufficient resources (RAM + GPU) to process request" -ForegroundColor Yellow;Write-Host "Consider reducing log size or maxTokens setting" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "  → Analysis received from LLM" -ForegroundColor Gray;Write-Host "";Write-Host "Generating report..." -ForegroundColor Cyan;$lfn=$lf|ForEach-Object{Split-Path -Path $_ -Leaf};$rs="Analysis of $($lf.Count) log file(s) totaling $lsk KB";$rc=New-Report -AnalysisText $ar -LogFileNames $lfn -Summary $rs;if([string]::IsNullOrWhiteSpace($rc)){Write-Error "Failed to generate report";Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "  → Report generated" -ForegroundColor Gray;Write-Host "";Write-Host "Saving report..." -ForegroundColor Cyan;$rsv=Save-Report -ReportContent $rc;if(-not $rsv){Write-Error "Failed to save report";Write-Host "Suggestion: Check that reports folder exists and is writable" -ForegroundColor Yellow;Write-Host "Verify disk space is available" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");return};Write-Host "";Write-Host "[OK] Analysis complete!" -ForegroundColor Green;Write-Host "";Write-Host "Report Details:" -ForegroundColor Cyan;Write-Host "  Files Analyzed: $($lf.Count)" -ForegroundColor White;Write-Host "  Total Size: $lsk KB" -ForegroundColor White;Write-Host "  Report Location: .\reports\" -ForegroundColor White;Write-Host "";Write-Host "Check the reports folder for your analysis results." -ForegroundColor Green;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}catch{Write-Error "An unexpected error occurred during log analysis: $_";Write-Host "Suggestion: Check the error message above for details" -ForegroundColor Yellow;Write-Host "Review log files for potential issues (corrupted data, invalid encoding)" -ForegroundColor Yellow;Write-Host "";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}}
function Start-App{try{Write-Host "";Write-Host "Starting CoLogger..." -ForegroundColor Cyan;Write-Host "";if(-not (Initialize-Folders)){Write-Error "Folder initialization failed. Cannot continue.";return};Write-Host "";Write-Host "CoLogger initialized successfully!" -ForegroundColor Green;Write-Host "";Start-Sleep -Seconds 2;$ir=$true;while($ir){try{$uc=Show-Menu;if($uc -eq -1){Write-Host "Press any key to try again..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown");continue};switch($uc){1{Invoke-TestConnection}2{Invoke-Analyze}3{Write-Host "";Write-Host "Thank you for using CoLogger!" -ForegroundColor Cyan;Write-Host "Exiting..." -ForegroundColor Cyan;$ir=$false}default{Write-Warning "Invalid menu option selected.";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}}}catch{Write-Error "An error occurred in the menu loop: $_";Write-Host "Press any key to continue..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}}}catch{Write-Error "Fatal error in CoLogger application: $_";Write-Host "Press any key to exit..." -ForegroundColor Gray;$null=$Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")}}
Start-App
